<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/google-map/google-map.html">

<dom-module id="x-map">
  <template>
    <style>
    google-map {
      width: 100%;
      height: 100vh;
      height: -webkit-calc(100vh - 64px);
      height: calc(100vh - 64px);
    }
    </style>

    <iron-ajax
      auto
      url="data/shops.json"
      last-response="{{shops}}"
    ></iron-ajax>

    <google-map disable-default-ui single-info-window
      gesture-handling="greedy"
      latitude="41.7741117" longitude="140.7209939" zoom="14" min-zoom="14">

      <template is="dom-repeat" items="[[shops]]">
        <google-map-marker slot="markers" latitude="[[item.position.lat]]" longitude="[[item.position.lng]]" icon="[[set_icon(item.open)]]">
          <p><b>[[item.shopname]]</b></p>
          <small>[[item.description]]</small>
          <p>[[is_open_string(item)]]</p>
        </google-map-marker>
      </template>

    </google-map>
  </template>

  <script>
  class XMap extends Polymer.Element {
    static get is() {return 'x-map';}
    set_icon(open) {
      if(this.is_open(open))
        return "http://localhost:8080/icon/pin_blue.png";
      else
        return "http://localhost:8080/icon/pin_red.png";
    }
    is_open_string(shop) {
      //TODO: ココで開いている店舗のリストを作って、表示したい。
      return this.is_open(shop.open) ? "営業中" : "本日の営業は終了しました";
    }
    is_open(open) {
      let s = new Date();
      let e = new Date();
      s.setHours(open.start.split(':')[0], open.start.split(':')[1]);
      e.setHours(open.end.split(':')[0],   open.end.split(':')[1]);
      return s < new Date() && e > new Date();
    }
  }
  customElements.define(XMap.is, XMap);
  </script>
</dom-module>
