<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/google-map/google-map.html">

<dom-module id="x-map">
  <template>
    <style>
    google-map {
      width: 100%;
      height: 100vh;
      height: -webkit-calc(100vh - 64px);
      height: calc(100vh - 64px);
    }
    </style>

    <iron-ajax
      auto
      url="data/shops.json"
      last-response="{{shops}}"
    ></iron-ajax>

    <google-map disable-default-ui single-info-window
      gesture-handling="greedy"
      latitude="41.7741117" longitude="140.7209939" zoom="14" min-zoom="14">

      <template is="dom-repeat" items="[[shops]]">
        <google-map-marker slot="markers" latitude="[[item.position.lat]]" longitude="[[item.position.lng]]" icon="[[set_icon(item.open)]]">
          <p><b>[[item.shopname]]</b></p>
          <small>[[item.description]]</small>
          <p>
            [[is_open_string(item.open)]]<br>
            <small>営業時間　[[item.open.start]] ~ [[item.open.end]]</small>
          </p>
        </google-map-marker>
      </template>

    </google-map>
  </template>

  <script>
  class XMap extends Polymer.Element {
    static get is() {return 'x-map';}
    set_icon(open) {
      if(this.is_open(open))
        return "icon/pin_blue.png";
      else
        return "icon/pin_red.png";
    }
    is_open_string(open) {
      return this.is_open(open) ? "営業中" : "営業時間外です";
    }
    is_open(open) {
      let s = new Date();
      let e = new Date();
      let n = new Date();
      let s_h, s_m, e_h, e_m;
      [s_h, s_m] = open.start.split(':');
      [e_h, e_m] = open.end.split(':');
      s.setHours(s_h, s_m);
      e.setHours(e_h, e_m);
      if(e_h > 24 && n.getHours() < 5) {
        s.setDate(s.getDate() - 1);
        e.setDate(e.getDate() - 1);
      }
      return s < n && e > n;
    }
  }
  customElements.define(XMap.is, XMap);
  </script>
</dom-module>
